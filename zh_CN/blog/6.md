# 本博客暂时未完成，所以不接受issue和pull request



### 6. 评测任务分配

[代码](6/代码)



《从内核开始 1》之后的又一次重头戏！

本来我想这次把它和数据库一起结束掉，但代码太多、太复杂了。数据库的开发工作只能等到下一次再做。

<br />

一台评测机最多同时测(CPU数 - 2)个测试点，否则会导致多个被测程序互相争抢CPU资源，测试结果出现随机性。

如果我们每次将一次评测分配给一台机器，那么这台机器必须先测前几个测试点，结束后再测后几个，而其他空闲评测机仍然在等待任务，却不能分担一下之前那台评测机的任务。

如果要实现真正的无排队评测，我们必须按照测试点分配任务。

评测任务分配很简单：把一次测试任务拆成子任务，然后把子任务加到子任务数组中。

每50ms扫描一遍子任务数组，把每个子任务的下一个测试点加如评测数组中，如果无下一个测试点说明这个子任务AC了，删除并告诉数据库结果，扫描完毕后再扫描一遍评测数组，将其中的测试点分配给评测端。

如果收到来自评测端的测试结果消息：AC了，就把结果放入所属子任务；未AC，仍把结果放入所属子任务，但然后将子任务删除，且告诉数据库这个子任务的结果。

但是大多数题没有子任务，怎么办？假设它有n个测试点，则“制造”n个“没有子任务时才会有子任务”，使第i个子任务中只有一个测试点，即第i个测试点。

由于要接收任务并和数据库通信，所以我们继续用Node.js做。

###### 2019.07.28